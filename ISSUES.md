# プロジェクトの問題点 (Issues)

このプロジェクトについて多角的に検証した結果、いくつかの問題点や改善点が特定されました。以下にその内容をまとめます。

## 重大な問題 (Critical Issues)

### 1. 正規化ロジックのテストが存在しない

- **問題点**:
  現在、`src/test/extension.test.ts` にはサンプルコードしかなく、この拡張機能の核心である日本語正規化ロジックに対するテストが一切書かれていません。
- **影響**:
  - バグの混入や意図しない動作の変更（リグレッション）を検知できません。
  - 特殊な文字（例: 異体字、サロゲートペア、結合文字）が正しく処理されるかどうかの品質が保証されていません。
  - 機能追加やリファクタリングを安全に行うことが困難です。
- **改善案**:
  - `Mocha` を利用して、正規化ロジックを検証する単体テストを実装します。
  - 以下のテストケースを含めるべきです。
    - SJISで変換可能な文字（変更されないこと）
    - NFC/NFKCで正規化されるべき文字（正しく変換されること）
    - `(株)` や `①` のような `cp932` 固有の文字
    - NFKCで複数文字に分解されるが、文字長が長くなるため採用されないケース
    - サロゲートペアで表現される絵文字など

## バグの可能性 (Potential Bugs)

### 1. 全文置換時に最終行が欠落する可能性がある

- **問題点**:
  テキスト全体を置換する際の範囲指定に不備があります。`new vscode.Range(new vscode.Position(0, 0), new vscode.Position(editor.document.lineCount, 0))` という指定では、ドキュメントの最終行の末尾までが含まれず、最終行にテキストが存在する場合にその内容が消えてしまう可能性があります。
- **改善案**:
  - 範囲の終端を `editor.document.lineAt(editor.document.lineCount - 1).range.end` を使ってドキュメントの真の末尾に設定することで、正確な全文置換を実装します。
    ```typescript
    // 修正前
    new vscode.Position(editor.document.lineCount, 0)
    // 修正後
    editor.document.lineAt(editor.document.lineCount - 1).range.end
    ```

## パフォーマンスの問題 (Performance Issues)

### 1. SJIS変換可能かのチェックが冗長

- **問題点**:
  `normalizeLine` 関数でまず行全体に対して `canConvertSJIS` を呼び、それで失敗した場合に `normalizeChar` 内でさらに一文字ずつ `canConvertSJIS` を呼んでいます。これは非効率です。
- **影響**:
  - SJISに変換できない文字を含む長い行がある場合、同じチェックが何度も繰り返され、処理速度が低下します。
- **改善案**:
  - 行単位のチェックを廃止し、文字単位のチェックに一本化するか、より効率的なアルゴリズムを検討します。例えば、一文字でもSJIS変換不可能な文字が見つかった時点で、その行の残りの文字は文字単位の正規化処理に回す、といったフラグ管理が考えられます。

### 2. 巨大なファイルでの動作速度

- **問題点**:
  ファイル全体を対象とした場合、すべての文字を一つずつループ処理し、内部で複数の正規化やエンコーディング変換を試行するため、数万行を超えるような巨大なファイルでは動作が非常に遅くなる可能性があります。
- **改善案**:
  - 一定以上のサイズを持つファイルに対しては、警告を表示しユーザーに実行を確認するUIを設けることを検討します。
  - 処理の進捗をプログレスバーで表示し、ユーザー体験を向上させます。

## 改善提案 (Suggestions for Improvement)

### 1. ドキュメントと実装の乖離 (バイト数 vs 文字数)

- **問題点**:
  `README.md` には、NFKCでの変換を採用する条件として「元の文字とバイト数が同じか、それ以下の場合のみ」と記載されています。しかし、`src/extension.ts` の実装では `normalizeNFKC.length <= char.length` となっており、**バイト数ではなく文字長（UTF-16コードユニット数）**で比較しています。
- **影響**:
  - ドキュメントと実際の動作が異なるため、ユーザーに誤解を与える可能性があります。
  - 文字によっては、バイト数と文字長で評価が変わり、意図しない結果になる可能性があります。
- **改善案**:
  - `README.md` の記述を実装に合わせて「文字長」に修正するか、あるいは実装を `Buffer.byteLength()` を使って「バイト数」での比較に修正します。どちらが本来意図した仕様か明確にする必要があります。

### 2. 曖昧なエンコーディング `shift_jis` の使用

- **問題点**:
  `iconv.encode` で `shift_jis` を指定しています。これはJIS X 0208を指しますが、Windows環境で一般的に「シフトJIS」として扱われるのは、機種依存文字などを追加した `cp932` (または `Windows-31J`) です。
- **影響**:
  - `①` `㈱` `髙` といった文字がSJIS変換不可能と判定され、意図せず正規化の対象になってしまう可能性があります。
- **改善案**:
  - 意図が `cp932` である場合、`iconv.encode(text, 'cp932')` のように明示的に指定することで、意図しない変換を防ぎ、コードの明確性を向上させます。

### 3. 設定機能の欠如

- **問題点**:
  正規化のルール（SJISを優先する、NFC/NFKCの適用順など）がハードコードされており、ユーザーが挙動をカスタマイズできません。
- **改善案**:
  - `package.json` の `contributes.configuration` と `vscode.workspace.getConfiguration` を利用して、以下のような設定項目を追加します。
    - 正規化の有効/無効
    - SJISチェックの有効/無効
    - 優先する正規化形式（NFC, NFKC）の選択
